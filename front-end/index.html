<html>
	<head>
		<script type="text/javascript" src="jquery-3.1.1.min.js"></script>
		<script type="text/javascript">
			var hash = window.location.hash;
			var parts = hash.split("&");
			var page = null;
			var search_term = null;

			for (i in parts) {
				var key_value = parts[i].split("=");

				if (key_value.length < 2) {
					continue;
				}

				var key = key_value[0];
				var value = key_value[1];

				if (key == "page") {
					page = parseInt(value);
				}

				if (key == "query") {
					search_term = value;
				}
			}

			if (page == null || isNaN(page)) {
				page = 1;
			}

		    var ES_url = "";
		    var facets_table_to_ES_field_map = ["cities" : "city", "employment_types" : "employment_type",
		                                        "hierarchy_levels" : "hierarchy_level"];
			var facets_table = {
			                    cities:[]
								employment_types:[]
			                    hierarchy_levels:[]};

			var ES_FILTERS = geterate_es_filters();
			var PAGE_SIZE = 15;

			function geterate_es_filters() {
				var es_filters = "";
				var last_property = null;

				for (last_property in facets_table);

				for (var key in facets_table) {
					var facet_arr = facets_table[key];
					for (i in facet_arr) {

						var ES_field = facets_table_to_ES_field_map[key];
						es_filters += '{"match" :{"'+ES_field+'": "';
						es_filters += facet_arr[i];
						es_filters += '"}}';
	
						if (key != last_property || i != facet_arr.length - 1) {
							es_filters += ",";
						}
					}
				}

				return es_filters;
			}

			$(document).ready(function() {
				$("#search-button").click(function() {
					var query = $("#search-field").text();
					search_term = query;
					reconstruct_hash();
					var ES_query = get_ES_query(query);
					get_result_count(ES_query);
					construct_pagination(result_count);
					$.get (ES_url+"_search?size"+PAGE_SIZE+"&from="+(PAGE_SIZE*(page-1)), { json: ES_query}, function (res){
					    
					});
				});
			});

			function reconstruct_hash() {
				window.location.hash = "page="+page+"&query="+query;
			}

			function get_result_count(ES_query) {
				$.get (ES_url+"_count", { json: ES_query}, function (res){
					res = JSON.parse(res);
					count = res.count;
					populate_pagination(count);
				});
			}

			function populate_pagination(count) {
				var page_count = Math.ceil(count/PAGE_SIZE);
				show_first_page(page_count);
				show_prev_page(page_count);
				show_current_page(page_count);
				show_next_page(page_count);
				show_last_page(page_count);
			}

			function show_first_page(page_count) {
				
			}

			function show_prev_page(page_count) {
				
			}

			function show_current_page(page_count) {
				
			}

			function show_next_page(page_count) {
				
			}

			function show_last_page(page_count) {
				
			}

			function get_ES_query(query) {
				var escaped_query = query.replace('"', '\"');
				var ES_query = "{"
			    	'"query": {'
			    		'"bool": {'
			    			'"should": ['
			    				'"match": {'
			    					'"jobTitle": "'+query+'"'
			    				'},'
			    				'"match": {'
			    					'"company": "'+query+'"'
			    				'},'
			    				'"match": {'
		    						'"text": "'+query+'"'
		    					'}'
			    			']'
			    		'}'
			    	'},  
			    	'"aggs" : {'
    					'"messages" : {'
      						'"filters" : {'
        						'"filters" : ['
          						+ES_FILTERS+
					        ']'
					      '}'
					    '}'
					  '}'
			    "}";
			}
		</script>
	</head>
	<body>
		<input id="search-field"></input><button id="search-button">Search Button</button>
		<div id="facets"></div>
		<div id="results"></div>
		<div id="pagination"></div>
	</body>
</html>