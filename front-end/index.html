<html>
<head>
<style>
</style>
<script type="text/javascript" src="jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="jquery-ui-1.12.1.custom/jquery-ui.js"></script>
<script type="text/javascript">
			var page = null;
			var search_term = null;

			var ES_url = "http://localhost:9200/";
		    var facets_table_to_ES_field_map = {"cities" : "city", "employment_types" : "employment_type",
		                                        "hierarchy_levels" : "hierarchy_level"};
			var facets_table = {
			                    cities:[],
								employment_types:[],
			                    hierarchy_levels:[]};

			var ES_FILTERS = geterate_es_filters();
			var PAGE_SIZE = 15;

			function trySearchByHash() {
				var hash = window.location.hash;

				hash = hash.substr(1, hash.length-1);

				var parts = hash.split("&");

				for (i in parts) {
					var key_value = parts[i].split("=");

					if (key_value.length < 2) {
						continue;
					}

					var key = key_value[0];
					var value = key_value[1];

					if (key == "page") {
						page = parseInt(value);
					}

					if (key == "query") {
						search_term = value;
					}

					if (page == null || isNaN(page)) {
						page = 1;
					}
				}

				perform_search(search_term, page);
			}

			trySearchByHash();

			$(window).on('hashchange', function() {
				trySearchByHash();
			});

			function geterate_es_filters() {
				var es_filters = [];

				for (var key in facets_table) {
					var facet_arr = facets_table[key];
					for (i in facet_arr) {
						var ES_field = facets_table_to_ES_field_map[key];

						es_filters.push(match_obj);
					}
				}

				return es_filters;
			}

			function perform_search(query, new_page) {
				if (query == null || query == "") {
					return;
				}

				search_term = query;
				var ES_query = get_ES_query(query);
				console.log(JSON.stringify(ES_query));
				get_result_count(ES_query);
				ES_query.aggs = {
    					messages : {
     						 filters : {
       						 	filters : ES_FILTERS
					       }
					    }
					};
				$.post(ES_url+"_search?size="+PAGE_SIZE+"&from="+new_page, JSON.stringify(ES_query), function (res){
					$("#results_table").empty();
					$("#result_modals").empty();

					var hits = res.hits.hits;

					for (i in hits) {
						var hit = hits[i];
						var title = hit._source.jobTitle;
						var text = hit._source.text;
						var id = hit._id;

						var modal_id = "modal_result_"+id;
						var element = "<tr class='result' id='result_"+id+"'><th class='result'>"+title+"</th></tr>";
						var modal_element = "<div id='"+modal_id+"'>"+text+"</div>";
						$("#results_table").append(element);
						$("#result_modals").append(modal_element);
						$("#"+modal_id).dialog({autoOpen: false});
					}
				}, "json");
			}

			$(document).ready(function() {
				$("#search-button").click(function() {
					var query = $("#search-field").val();
					search_term = query;
					perform_search(query, 1);
					reconstruct_hash();
				});
			});

			function reconstruct_hash() {
				window.location.hash = "page="+page+"&query="+search_term;
			}

			function get_result_count(ES_query) {
				$.post(ES_url+"_count", JSON.stringify(ES_query), function (res){
					count = res.count;
					populate_pagination(count);
				}, "json");
			}

			function populate_pagination(page_count) {
				$("#pagination").empty();

				if (page_count == 0) {
					return;
				}

				var page_count = Math.ceil(page_count/PAGE_SIZE);
				show_first_page(page_count);
				show_prev_page(page_count);
				show_current_page(page_count);
				show_next_page(page_count);
				show_last_page(page_count);
			}

			function show_first_page(page_count) {
				var new_element = null;

				if (page == 1) {
					new_element = "<span>&lt;&lt;first</span>";
				} else {
					new_element = "<a href='"+generate_page_link(1)+"'>&lt;&lt;first</a>";
				}

				$("#pagination").append(new_element+" ");
			}

			function generate_page_link(new_page) {
				return "#page="+new_page+"&query="+search_term;
			}

			function show_prev_page(page_count) {
				var new_element = null;

				if (page == 1) {
					new_element = "<span>&lt;previous</span>";
				} else {
					new_element = "<a href='"+generate_page_link(page-1)+"'>&lt;previous</a>";
				}

				$("#pagination").append(new_element+" ");
			}

			function show_current_page(page_count) {
				var start_page = page-3;

				if (start_page <= 1) {
					start_page = 1;
				}

				var end_page = start_page + 6;

				if (end_page > page_count-1) {
					end_page = page_count;
				}

				var pages_left = 9 - (end_page - start_page);
				if (start_page > 2) {
					$("#pagination").append("...");
				}

				print_page_interval(start_page, end_page);

				if (end_page <= page_count-1) {
					var next_start = page_count - pages_left;
					var next_end = page_count;

					if (next_start <= start_page + 1) {
						next_start = start_page+1;
					} else {
						$("#pagination").append("...");
					}

					print_page_interval(next_start, next_end);
				}
			}

			function print_page_interval(start, end) {
				for (var i=start;i<end;++i) {
					var new_element = null;

					if (i == page) {
						new_element = "<span>"+i+"</span>";
					} else {
						new_element = "<a href='"+generate_page_link(i)+"'>"+i+"</a>";
					}

					$("#pagination").append(new_element+" ");
				}				
			}

			function show_next_page(page_count) {
				var new_element = null;

				if (page == page_count) {
					new_element = "<span>next></span>";
				} else {
					new_element = "<a href='"+generate_page_link(page+1)+"'>next></a>";
				}

				$("#pagination").append(new_element+" ");
			}

			function show_last_page(page_count) {
				var new_element = null;

				if (page == page_count) {
					new_element = "<span>last>></span>";
				} else {
					new_element = "<a href='"+generate_page_link(page_count)+"'>last>></a>";
				}

				$("#pagination").append(new_element);
			}

			function get_ES_query(query) {
				var escaped_query = query.replace('"', '\"');
				var ES_query = {
			    	query: {
			    		bool: {
			    			should: [
			    				{
			    					match: {
			    						jobTitle: query
			    					}
			    				},
			    				{
			    					match: {
			    						company: query
			    					}
			    				},
			    				{
			    					match: {
		    							text: query
		    						}
			    				}
			    			]
			    		}
			    	}
				};

			    return ES_query;
			}
		</script>
</head>
<body>
	<input id="search-field"></input>
	<button id="search-button">Search Button</button>
	<div id="facets"></div>
	<div id="results">
		<table id="results_table" style="width:100%"></table>
	</div>
	<div id="result_modals"></div>
	<div id="pagination"></div>
</body>
</html>